<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBTI思辩交互系统 - 前端测试</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            background: #fafafa;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .result-area {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-item {
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-item h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .result-item .content {
            margin: 10px 0;
            line-height: 1.6;
        }

        .result-item .analysis {
            margin-top: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-left: 3px solid #28a745;
            font-size: 0.9em;
            color: #666;
        }

        .mbti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .mbti-option {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mbti-option:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .mbti-option.selected {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .debate-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .debate-side {
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            background: white;
        }

        .debate-side h4 {
            margin-bottom: 15px;
            color: #333;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .error {
            color: #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .success {
            color: #155724;
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 15px 30px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>MBTI思辩交互系统</h1>
            <p>基于MBTI人格类型的AI辩论与建议系统</p>
        </div>

        <div class="content">
            <!-- 登录注册区域 -->
            <div class="section">
                <h2>用户认证</h2>
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('login')">登录</button>
                    <button class="tab" onclick="switchTab('register')">注册</button>
                </div>

                <div id="login" class="tab-content active">
                    <div class="form-group">
                        <label for="loginUsername">用户名</label>
                        <input type="text" id="loginUsername" placeholder="请输入用户名">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">密码</label>
                        <input type="password" id="loginPassword" placeholder="请输入密码">
                    </div>
                    <button class="btn" onclick="login()">登录</button>
                    <div id="loginResult"></div>
                </div>

                <div id="register" class="tab-content">
                    <div class="form-group">
                        <label for="registerUsername">用户名</label>
                        <input type="text" id="registerUsername" placeholder="请输入用户名">
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">密码</label>
                        <input type="password" id="registerPassword" placeholder="请输入密码">
                    </div>
                    <button class="btn" onclick="register()">注册</button>
                    <div id="registerResult"></div>
                </div>
            </div>

            <!-- 功能选择区域 -->
            <div class="section" id="functionSection" style="display: none;">
                <h2>功能选择</h2>
                <button class="btn btn-success" onclick="showAdviceSection()">获取MBTI建议</button>
                <button class="btn btn-warning" onclick="showDebateSection()">开始辩论</button>
                <button class="btn btn-secondary" onclick="showHistory()">查看历史记录</button>
            </div>

            <!-- 建议功能区域 -->
            <div class="section" id="adviceSection" style="display: none;">
                <h2>MBTI建议</h2>
                <div class="form-group">
                    <label for="adviceQuestion">您的问题</label>
                    <textarea id="adviceQuestion" rows="4" placeholder="请描述您的问题或困惑..."></textarea>
                </div>
                <div class="form-group">
                    <label>选择MBTI类型（可多选）</label>
                    <div class="mbti-grid" id="adviceMbtiGrid"></div>
                </div>
                <button class="btn" onclick="getAdvice()">获取建议</button>
                <button class="btn btn-secondary" onclick="backToFunction()">返回</button>
                <div id="adviceResult" class="result-area" style="display: none;"></div>
                <div id="adviceFollowup" style="display:none; margin-top:20px;">
                    <textarea id="followupInput" rows="2" placeholder="请输入您的追问..."></textarea>
                    <button class="btn btn-success" onclick="sendFollowup()">追问</button>
                </div>
                <div id="adviceHistory" class="result-area" style="display:none;"></div>
            </div>

            <!-- 辩论功能区域 -->
            <div class="section" id="debateSection" style="display: none;">
                <h2>辩论设置</h2>
                <div class="form-group">
                    <label for="debateTopic">辩题</label>
                    <input type="text" id="debateTopic" placeholder="请输入辩题，例如：人工智能是否会取代人类工作">
                </div>
                <div class="debate-config">
                    <div class="debate-side">
                        <h4>正方配置</h4>
                        <div class="form-group">
                            <label>正方一辩</label>
                            <select id="pro1Mbti"></select>
                        </div>
                        <div class="form-group">
                            <label>正方二辩</label>
                            <select id="pro2Mbti"></select>
                        </div>
                        <div class="form-group">
                            <label>正方三辩</label>
                            <select id="pro3Mbti"></select>
                        </div>
                        <div class="form-group">
                            <label>正方四辩</label>
                            <select id="pro4Mbti"></select>
                        </div>
                    </div>
                    <div class="debate-side">
                        <h4>反方配置</h4>
                        <div class="form-group">
                            <label>反方一辩</label>
                            <select id="opp1Mbti"></select>
                        </div>
                        <div class="form-group">
                            <label>反方二辩</label>
                            <select id="opp2Mbti"></select>
                        </div>
                        <div class="form-group">
                            <label>反方三辩</label>
                            <select id="opp3Mbti"></select>
                        </div>
                        <div class="form-group">
                            <label>反方四辩</label>
                            <select id="opp4Mbti"></select>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="startDebate()">开始辩论</button>
                <button class="btn btn-secondary" onclick="backToFunction()">返回</button>
                <div id="debateResult" class="result-area" style="display: none;"></div>
            </div>

            <!-- 历史记录区域 -->
            <div class="section" id="historySection" style="display: none;">
                <h2>历史记录</h2>
                <button class="btn" onclick="loadHistory()">加载历史记录</button>
                <button class="btn btn-secondary" onclick="backToFunction()">返回</button>
                <div id="historyResult" class="result-area" style="display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentUser = null;
        let mbtiTypes = [];
        let adviceHistory = [];
        let lastAdviceMbtiTypes = [];

        // 页面加载时初始化
        window.onload = async function() {
            await loadMbtiTypes();
        };

        // 切换标签页
        function switchTab(tabName) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // 显示选中的标签内容
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // 加载MBTI类型
        async function loadMbtiTypes() {
            try {
                const response = await fetch(`${API_BASE}/mbti_types`);
                const data = await response.json();
                mbtiTypes = data.mbti_types;
                
                // 填充建议页面的MBTI网格
                const adviceGrid = document.getElementById('adviceMbtiGrid');
                adviceGrid.innerHTML = mbtiTypes.map(type => 
                    `<div class="mbti-option" onclick="toggleMbtiSelection(this, '${type}')">${type}</div>`
                ).join('');

                // 填充辩论页面的下拉框
                ["pro1Mbti","pro2Mbti","pro3Mbti","pro4Mbti","opp1Mbti","opp2Mbti","opp3Mbti","opp4Mbti"].forEach(id => {
                    const sel = document.getElementById(id);
                    sel.innerHTML = mbtiTypes.map(type => `<option value="${type}">${type}</option>`).join('');
                });
            } catch (error) {
                console.error('加载MBTI类型失败:', error);
            }
        }

        // 切换MBTI选择
        function toggleMbtiSelection(element, mbtiType) {
            element.classList.toggle('selected');
        }

        // 获取选中的MBTI类型
        function getSelectedMbtiTypes() {
            const selected = document.querySelectorAll('.mbti-option.selected');
            return Array.from(selected).map(el => el.textContent);
        }

        // 用户注册
        async function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const resultDiv = document.getElementById('registerResult');

            if (!username || !password) {
                resultDiv.innerHTML = '<div class="error">请填写用户名和密码</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_name: username,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = '<div class="success">注册成功！</div>';
                    document.getElementById('registerUsername').value = '';
                    document.getElementById('registerPassword').value = '';
                } else {
                    resultDiv.innerHTML = `<div class="error">注册失败: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">注册失败: ${error.message}</div>`;
            }
        }

        // 用户登录
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const resultDiv = document.getElementById('loginResult');

            if (!username || !password) {
                resultDiv.innerHTML = '<div class="error">请填写用户名和密码</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_name: username,
                        password: password
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentUser = {
                        id: data.user_id,
                        username: username
                    };
                    resultDiv.innerHTML = '<div class="success">登录成功！</div>';
                    document.getElementById('functionSection').style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<div class="error">登录失败: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">登录失败: ${error.message}</div>`;
            }
        }

        // 显示建议区域
        function showAdviceSection() {
            hideAllSections();
            document.getElementById('adviceSection').style.display = 'block';
        }

        // 显示辩论区域
        function showDebateSection() {
            hideAllSections();
            document.getElementById('debateSection').style.display = 'block';
        }

        // 显示历史记录区域
        function showHistory() {
            hideAllSections();
            document.getElementById('historySection').style.display = 'block';
        }

        // 隐藏所有功能区域
        function hideAllSections() {
            document.getElementById('adviceSection').style.display = 'none';
            document.getElementById('debateSection').style.display = 'none';
            document.getElementById('historySection').style.display = 'none';
        }

        // 返回功能选择
        function backToFunction() {
            hideAllSections();
            document.getElementById('functionSection').style.display = 'block';
        }

        // 获取建议
        async function getAdvice() {
            const question = document.getElementById('adviceQuestion').value;
            const selectedMbtiTypes = getSelectedMbtiTypes();
            const resultDiv = document.getElementById('adviceResult');

            if (!question) {
                resultDiv.innerHTML = '<div class="error">请输入您的问题</div>';
                resultDiv.style.display = 'block';
                return;
            }

            if (selectedMbtiTypes.length === 0) {
                resultDiv.innerHTML = '<div class="error">请至少选择一个MBTI类型</div>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<div class="loading">正在生成建议...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/advice`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id.toString(),
                        question: question,
                        mbti_types: selectedMbtiTypes
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    let resultHtml = '<h3>建议结果:</h3>';
                    for (const [mbtiType, advice] of Object.entries(data.responses)) {
                        resultHtml += `
                            <div class="result-item">
                                <h4>${mbtiType} 的建议:</h4>
                                <p>${advice}</p>
                            </div>
                        `;
                    }
                    resultDiv.innerHTML = resultHtml;
                    // 多轮对话历史
                    adviceHistory = [{question, mbti_types: selectedMbtiTypes, responses: data.responses}];
                    lastAdviceMbtiTypes = selectedMbtiTypes;
                    showAdviceHistory();
                    document.getElementById('adviceFollowup').style.display = 'block';
                } else {
                    resultDiv.innerHTML = `<div class="error">获取建议失败: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">获取建议失败: ${error.message}</div>`;
            }
        }

        function showAdviceHistory() {
            const histDiv = document.getElementById('adviceHistory');
            let html = '';
            adviceHistory.forEach((item, idx) => {
                html += `<div class='result-item'><b>第${idx+1}轮</b><br><b>问题/追问:</b> ${item.question}<br>`;
                for (const [mbti, resp] of Object.entries(item.responses)) {
                    html += `<b>${mbti}:</b> ${resp}<br>`;
                }
                html += '</div>';
            });
            histDiv.innerHTML = html;
            histDiv.style.display = 'block';
        }

        async function sendFollowup() {
            const followup = document.getElementById('followupInput').value;
            if (!followup) return;
            const resultDiv = document.getElementById('adviceResult');
            resultDiv.innerHTML = '<div class="loading">正在生成追问回复...</div>';
            resultDiv.style.display = 'block';
            try {
                const response = await fetch(`${API_BASE}/advice/followup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id.toString(),
                        question: followup,
                        mbti_targets: lastAdviceMbtiTypes
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    let resultHtml = '<h3>追问回复:</h3>';
                    for (const [mbtiType, advice] of Object.entries(data.responses)) {
                        resultHtml += `<div class="result-item"><h4>${mbtiType} 的追问回复:</h4><p>${advice}</p></div>`;
                    }
                    resultDiv.innerHTML = resultHtml;
                    // 追加到历史
                    adviceHistory.push({question: followup, mbti_types: lastAdviceMbtiTypes, responses: data.responses});
                    showAdviceHistory();
                    document.getElementById('followupInput').value = '';
                } else {
                    resultDiv.innerHTML = `<div class="error">追问失败: ${data.detail}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">追问失败: ${error.message}</div>`;
            }
        }

        // 开始辩论
        async function startDebate() {
            const topic = document.getElementById('debateTopic').value;
            const pro1 = document.getElementById('pro1Mbti').value;
            const pro2 = document.getElementById('pro2Mbti').value;
            const pro3 = document.getElementById('pro3Mbti').value;
            const pro4 = document.getElementById('pro4Mbti').value;
            const opp1 = document.getElementById('opp1Mbti').value;
            const opp2 = document.getElementById('opp2Mbti').value;
            const opp3 = document.getElementById('opp3Mbti').value;
            const opp4 = document.getElementById('opp4Mbti').value;
            const resultDiv = document.getElementById('debateResult');

            if (!topic) {
                resultDiv.innerHTML = '<div class="error">请输入辩题</div>';
                resultDiv.style.display = 'block';
                return;
            }

            resultDiv.innerHTML = '<div class="loading">正在生成辩论内容...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/debate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: topic,
                        mbti_config: {
                            "pro1": pro1, "pro2": pro2, "pro3": pro3, "pro4": pro4,
                            "opp1": opp1, "opp2": opp2, "opp3": opp3, "opp4": opp4
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let resultHtml = '<h3>辩论内容:</h3>';
                let currentSpeechDiv = null;

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n').filter(line => line.trim());

                    for (const line of lines) {
                        try {
                            const data = JSON.parse(line);
                            
                            switch (data.type) {
                                case 'speech_start':
                                    // 创建新的发言div
                                    currentSpeechDiv = document.createElement('div');
                                    currentSpeechDiv.className = 'result-item';
                                    currentSpeechDiv.innerHTML = `<h4>${data.agent_id} (${data.stage}) - 第${data.round}轮</h4><div class="content"></div>`;
                                    resultDiv.appendChild(currentSpeechDiv);
                                    break;
                                    
                                case 'speech_char':
                                    // 实时更新当前发言内容
                                    if (currentSpeechDiv) {
                                        const contentDiv = currentSpeechDiv.querySelector('.content');
                                        contentDiv.textContent += data.content;
                                    }
                                    break;
                                    
                                case 'speech_complete':
                                    // 发言完成，添加分析内容
                                    if (currentSpeechDiv && data.analysis && data.analysis.length > 0) {
                                        const analysisDiv = document.createElement('div');
                                        analysisDiv.className = 'analysis';
                                        analysisDiv.innerHTML = `<strong>分析:</strong> ${data.analysis.join(', ')}`;
                                        currentSpeechDiv.appendChild(analysisDiv);
                                    }
                                    currentSpeechDiv = null;
                                    break;
                                    
                                case 'complete':
                                    const completeDiv = document.createElement('div');
                                    completeDiv.className = 'success';
                                    completeDiv.textContent = data.message;
                                    resultDiv.appendChild(completeDiv);
                                    break;
                                    
                                case 'error':
                                    const errorDiv = document.createElement('div');
                                    errorDiv.className = 'error';
                                    errorDiv.textContent = `错误: ${data.error}`;
                                    resultDiv.appendChild(errorDiv);
                                    break;
                            }
                        } catch (e) {
                            console.error('解析JSON失败:', e, line);
                        }
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">辩论生成失败: ${error.message}</div>`;
            }
        }

        // 加载历史记录
        async function loadHistory() {
            const resultDiv = document.getElementById('historyResult');
            resultDiv.innerHTML = '<div class="loading">正在加载历史记录...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/history`);
                const data = await response.json();
                
                let resultHtml = '<h3>历史记录:</h3>';
                
                if (data.debate_history && data.debate_history.length > 0) {
                    resultHtml += '<h4>辩论历史:</h4>';
                    data.debate_history.forEach((record, index) => {
                        resultHtml += `
                            <div class="result-item">
                                <h4>辩论 ${index + 1}</h4>
                                <p><strong>辩题:</strong> ${record.topic}</p>
                                <p><strong>配置:</strong> ${JSON.stringify(record.mbti_config)}</p>
                                <p><strong>内容数量:</strong> ${record.history.length}</p>
                            </div>
                        `;
                    });
                }
                
                if (data.advice_history && data.advice_history.length > 0) {
                    resultHtml += '<h4>建议历史:</h4>';
                    data.advice_history.forEach((record, index) => {
                        resultHtml += `
                            <div class="result-item">
                                <h4>建议 ${index + 1}</h4>
                                <p><strong>问题:</strong> ${record.question}</p>
                                <p><strong>MBTI类型:</strong> ${record.mbti_types.join(', ')}</p>
                                <p><strong>用户ID:</strong> ${record.user_id}</p>
                            </div>
                        `;
                    });
                }
                
                if ((!data.debate_history || data.debate_history.length === 0) && 
                    (!data.advice_history || data.advice_history.length === 0)) {
                    resultHtml += '<div class="success">暂无历史记录</div>';
                }
                
                resultDiv.innerHTML = resultHtml;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">加载历史记录失败: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html> 