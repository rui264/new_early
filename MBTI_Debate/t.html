<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>MBTI 辩论系统测试</title>
    <style>
        body { font-family: "微软雅黑", Arial, sans-serif; margin: 40px; }
        label { display: inline-block; width: 60px; }
        select, input[type="text"] { margin-bottom: 10px; }
        #result { background: #f4f4f4; padding: 10px; border-radius: 5px; margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h2>MBTI 辩论系统测试</h2>
    <div>
        <label>辩题：</label>
        <input type="text" id="topic" value="人工智能是否会取代人类工作" style="width:300px;">
    </div>
    <div id="mbti-selects"></div>
    <button onclick="startDebate()">开始辩论</button>
    <pre id="result"></pre>

    <script>
        // 角色列表
        const speakers = ["opp1", "opp2", "opp3", "opp4", "pro1", "pro2", "pro3", "pro4"];
        let mbtiTypes = [];

        // 获取MBTI类型并渲染下拉框
        fetch("http://127.0.0.1:8066/mbti_types")
            .then(res => res.json())
            .then(data => {
                mbtiTypes = data.mbti_types;
                let html = "";
                speakers.forEach(speaker => {
                    html += `<label>${speaker}：</label>
                        <select id="${speaker}">
                            ${mbtiTypes.map(type => `<option value="${type}">${type}</option>`).join("")}
                        </select><br>`;
                });
                document.getElementById("mbti-selects").innerHTML = html;
            });

        // 提交辩论请求
        function startDebate() {
            const topic = document.getElementById("topic").value;
            const mbti_config = {};
            speakers.forEach(speaker => {
                mbti_config[speaker] = document.getElementById(speaker).value;
            });

            document.getElementById("result").textContent = "正在请求，请稍候...\n";

            fetch("http://127.0.0.1:8066/debate", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({topic, mbti_config})
            })
            .then(response => {
                if (!response.body) throw new Error("No stream");
                const reader = response.body.getReader();
                let decoder = new TextDecoder();
                let result = "";
                function read() {
                    reader.read().then(({done, value}) => {
                        if (done) return;
                        result += decoder.decode(value, {stream: true});
                        document.getElementById("result").textContent = result;
                        read();
                    });
                }
                read();
            })
            .catch(err => {
                document.getElementById("result").textContent = "请求失败：" + err;
            });
        }
    </script>
</body>
</html>